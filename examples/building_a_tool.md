# Building the fort.14 Reader Tool

## Introduction

The xmstool_runner package contains four different demonstration tools:
UGrid from "fort.14" File, Datasets from "fort.13" File, Dataset from "fort.63.nc" File, and Transform UGrid points.
This document goes through the process of adding the UGrid from fort.14 File tool to `xmstool_runner`.

## Refactoring the existing code

The initial code for reading a fort.14 file can be found in `intial_adcirc_readers/fort14_reader.py`.
The reader code was prepared for the tool in the following ways:

- SMS integration that used `query` was removed.
- Building and writing mapped BC component data was removed.
- Building the default simulation was removed.
- Levee and pipe processing was removed.
- The reader was changed to accept a `logging.Logger` object.

These changes resulted in a `Fort14Reader class focused on reading the UGrid geometry.

## Creating the Tool Class

All tools inherit from an abstract base class called `Tool`.
The definition for `Tool` is located in `xmstool_core`. 
The tool should inherit from `Tool` and call its constructor as follows:


```python
from xms.tool_core import Argument, IoDirection, Tool

class UGridFromFort14Tool(Tool):
    """Tool to create a UGrid from a "fort.14" file."""

    def __init__(self):
        """Constructor."""
        super().__init__(name='UGrid from fort.14 File')
```

The name passed to the `Tool` constructor is a user-friendly short name for the tool.

## Defining the Tool Arguments

Tools can have input and output arguments that allow the user to select input data for your tool to process.
There are different argument types that are available to specify what type of data your tool can receive or output.
The available argument types are listed below:

- Float: A floating point value.
- Integer: An integer value.
- String: A string value.
- Bool: A (yes/no) value. 
- File: Allows the user to select a file/folder using a file select dialog.
- Grid: Allows the user to select a Grid from the project explorer via a drop-down menu.
- Dataset: Allows the user to select a Dataset from the project explorer via a drop-down menu.
- Coverage: Allows the user to select a Coverage from the project explorer via a drop-down menu.
- Raster: Allows the user to select a Raster from the project explorer via a drop-down menu.
- Time step: Allows the user to select a dataset time step.
- Table: Allows the user to enter a table of values.

Arguments can either be input or output.
When an argument is input, the tool is taking in data from the user to process.
When an argument is output, the tool gives the user data that resulted from the tool's operations.
An example of a Dataset output argument would be when a Dataset is generated by a tool
and added to the project explorer upon completion.

Our tool will make use of an input file argument and an output grid argument.
The first step in adding these arguments to our tool is to provide identifying indices for each argument.
We will do this by adding class variables to our `UGridFromFort14Tool` class.

Next, we must override the `initial_arguments()` method that is inherited from the `Tool` class.
The `initial_arguments()` method returns a list of the tool's arguments in their initial states.
This is where we will create the tool's arguments by putting them into the list returned by this method.
The order of the arguments in the list should correspond to the same order
defined by our class variables `ARG_INPUT_FILE`, and `ARG_OUTPUT_UGRID`. 
The definition for our tool's `initial_arguments()` method is given below:


```python
class UGridFromFort14Tool(Tool):
    """Tool to create a UGrid from a "fort.14" file."""

    # Add an identifying index for each argument available to our tool
    ARG_INPUT_FILE = 0
    ARG_OUTPUT_UGRID = 1

    def initial_arguments(self) -> list[Argument]:
        """Get initial arguments for the tool.

        Must override.

        Returns:
            (list): A list of the initial tool arguments.
        """
        arguments = [
            self.file_argument(name='fort_14_file', description='Input fort.14 file'),
            self.grid_argument(name='ugrid_name', description='Name of the output UGrid',
                               io_direction=IoDirection.OUTPUT)
        ]
        return arguments
```

To fill our list with arguments, we use the `file_argument()` method and the `grid_argument()` method.
The `Tool` class provides methods for creating each argument type.

## The Run Algorithm

Now that we have the arguments for our tool set up, it is time to override the `run()` method.
The `run()` method is called to execute your tool on the input data.
Ideally, the `run()` method will call a separate class or function that performs the actual algorithm.
This way, the algorithm performed can be called independent of your tool if needed.
Our tool retrieves the argument values, uses a `Fort14Reader` to read the values, and then sets the output grid.


```python
class UGridFromFort14Tool(Tool):
    """Tool to create a UGrid from a "fort.14" file."""
    def run(self, arguments: list[Argument]) -> None:
        """Override to run the tool.

        Args:
            arguments (list): The tool arguments.
        """
        # get the input fort.14 file
        fort_14_file = arguments[self.ARG_INPUT_FILE].text_value
        # read the UGrid and WKT
        fort_14_reader = Fort14Reader(fort_14_file, logger=self.logger)
        co_grid, wkt = fort_14_reader.read()
        # set the output grid
        self.set_output_grid(co_grid, arguments[self.ARG_OUTPUT_UGRID], projection=wkt)
```

## Completed Tool Code

The complete code for our tool is shown below.


```python
# Import needed for Tool
from xms.tool_core import Argument, Tool
from xms.adcirc import Fort14Reader


class UGridFromFort14Tool(Tool):
    """Tool to create a UGrid from a "fort.14" file."""
    ARG_INPUT_FILE = 0
    ARG_OUTPUT_UGRID = 1

    def __init__(self):
        """Constructor."""
        super().__init__(name='UGrid from fort.14 File')

    def initial_arguments(self) -> list[Argument]:
        """Get initial arguments for tool.

        Must override.

        Returns:
            (list): A list of the initial tool arguments.
        """
        arguments = [
            self.file_argument(name='fort_14_file', description='Input fort.14 file'),
            self.grid_argument(name='ugrid_name', description='Name of the output UGrid')
        ]
        return arguments

    def run(self, arguments: list[Argument]) -> None:
        """Override to run the tool.

        Args:
            arguments (list): The tool arguments.
        """
        # get the input fort.14 file
        fort_14_file = arguments[self.ARG_INPUT_FILE].text_value
        # read the UGrid and WKT
        fort_14_reader = Fort14Reader(fort_14_file, logger=self.logger)
        co_grid, wkt = fort_14_reader.read()
        # set the output grid
        self.set_output_grid(co_grid, arguments[self.ARG_OUTPUT_UGRID], projection=wkt)

```

## Registering the Tool

In order for our tool to appear when running `xmstool_runner`, we need to add its information into a `Tools.xml` file.
The XML file is used to find and load the available tools.

```
    <tool name="UGrid from fort.14 File"
          category="ADCIRC"
          description="Create a UGrid from a fort.14 file."
          class_name="UGridFromFort14Tool"
          module_name="xms.adcirc_tools"
          program_name="SMS"
          uuid="3bc02c02-4449-4e6e-924f-0c16a3d35004"/>
```

To complete the tool registration, the `pyproject.toml` file must include a classifier as follows:

```
[project]
...
classifiers = ['XMS DMI Definition :: XML :: xms/tool_runner/tools/Tools.xml']

[project.entry-points."xms.dmi.interfaces"]
tool_runner = "xms.tool_runner"
```

Now when the package gets installed the registered tool will be loaded into the `tool_runner` interface.
