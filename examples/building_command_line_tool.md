# Building the Transform UGrid Points Tool

## Introduction

The Transform UGrid Points tool uses the GDAL command line tools to transform
the points of a UGrid. This document describes how to build the tool.

## Creating the Tool Class

All tools inherit from an abstract base class called `Tool`. The definition for `Tool` is located in `xmstool_core`. 
A tool should inherit from `Tool` and call its constructor as follows:


```python
# Imports required by tool
from pathlib import Path
import subprocess

import numpy as np

from xms.constraint import UnconstrainedGrid
from xms.core.filesystem import filesystem
from xms.grid.ugrid import UGrid

from xms.tool_core import Argument, IoDirection, Tool


class TransformUgridPointsTool(Tool):
    """Tool to transform Ugrid points between projections."""

    def __init__(self):
        """Constructor."""
        super().__init__(name='Transform UGrid Points')
```

The name passed to the `Tool` constructor is a user-friendly short name for the tool.

## Defining the Tool Arguments

Tools can have input and output arguments that allow the user to select input
data for your tool to process. There are different argument types that are
available to specify what type of data your tool can receive or output. The
available argument types are listed below:

- Float: A floating point value.
- Integer: An integer value.
- String: A string value.
- Boolean: A (yes/no) value. 
- File: Allows the user to select a file/folder using a file select dialog.
- Grid: Allows the user to select a Grid from the project explorer via a drop-down menu.
- Dataset: Allows the user to select a Dataset from the project explorer via a drop-down menu.
- Coverage: Allows the user to select a Coverage from the project explorer via a drop-down menu.
- Raster: Allows the user to select a Raster from the project explorer via a drop-down menu.
- Time step: Allows the user to select a dataset time step.
- Table: Allows the user to enter a table of values.

Arguments can either be input or output. When an argument is input, the tool is
taking in data from the user to process. When an argument is output, the tool
gives the user data that resulted from the tool's operations. An example of a
Dataset output argument would be when a Dataset is generated by a tool and added
to the project explorer upon completion.

Our tool will make use of arguments for an input grid, an optional file path to
the GDAL tools, an input EPSG code, an output EPSG code, and an output grid. The
first step in adding these arguments to our tool is to provide identifying
indices for each argument. We will do this by adding class variables to our
`TransformUgridPointsTool` class.

Next, we must override the `initial_arguments()` method that is inherited from
the `Tool` class. The `initial_arguments()` method returns a list of the tool's
arguments in their initial states. This is where we will create the tool's
arguments by putting them into the list returned by this method. The order of the
arguments in the list should correspond to the same order defined by our class
variables `ARG_INPUT_GRID`, through `ARG_OUTPUT_UGRID`. The definition for our tool's
`initial_arguments()` method is given below:


```python
class TransformUgridPointsTool(Tool):
    """Tool to transform Ugrid points between projections."""

    # Add an identifying index for each argument available to our tool
    ARG_INPUT_GRID = 0
    ARG_GDAL_TOOLS_PATH = 1
    ARG_EPSG_CODE_FROM = 2
    ARG_EPSG_CODE_TO = 3
    ARG_OUTPUT_GRID = 4

    def initial_arguments(self) -> list[Argument]:
        """Get initial arguments for tool.

        Must override.

        Returns:
            (list): A list of the initial tool arguments.
        """
        arguments = [
            self.grid_argument(name="input_grid", description="Input UGrid"),
            self.file_argument(name="gdal_tools_path", description="Path to GDAL command line tools",
                               select_folder=True, value="", optional=True),
            self.integer_argument(name="epsg_code_from", description="EPSG code from"),
            self.integer_argument(name="epsg_code_to", description="EPSG code to"),
            self.grid_argument(name="output_grid", description="Output UGrid", io_direction=IoDirection.OUTPUT)
        ]
        return arguments
```

To fill our list with arguments, we use the `grid_argument()`, `file_argument()`, and `integer_argument()` methods.
The `Tool` class provides methods for creating each argument type.

## The Run Algorithm

Now that we have the arguments for our tool set up, it is time to override the
`run()` method. The `run()` method is called to execute your tool on the input
data. Our tool retrieves the argument values, transforms the points, gets the
WKT of the output projection, and then sets the output grid.


```python
class TransformUgridPointsTool(Tool):
    """Tool to transform Ugrid points between projections."""
    def run(self, arguments: list[Argument]) -> None:
        """Override to run the tool.

        Args:
            arguments (list): The tool arguments.
        """
        # get the input values
        input_grid = arguments[self.ARG_INPUT_GRID].text_value
        gdal_tools_path = arguments[self.ARG_GDAL_TOOLS_PATH].text_value
        epsg_code_from = arguments[self.ARG_EPSG_CODE_FROM].value
        epsg_code_to = arguments[self.ARG_EPSG_CODE_TO].value
        co_grid_in = self.get_input_grid(input_grid)
        ugrid_in = co_grid_in.ugrid
        locations_in = np.array(ugrid_in.locations)

        # get the new grid point locations
        locations_out = self._transform_points(gdal_tools_path, locations_in, epsg_code_from, epsg_code_to)
        # get the output projection's WKT
        wkt = self._wkt_from_epsg(gdal_tools_path, epsg_code_to)

        # build and set the output grid
        ugrid_out = UGrid(locations_out, ugrid_in.cellstream)
        co_grid_out = UnconstrainedGrid(ugrid_out)
        self.set_output_grid(co_grid_out, arguments[self.ARG_OUTPUT_GRID], wkt)
```

## Transforming the Points

The tool transforms the points between the two projections using the GDAL
`gdaltransform` command line utility as shown below.


```python
class TransformUgridPointsTool(Tool):
    """Tool to transform Ugrid points between projections."""
    def _transform_points(self, gdal_tools_path: str,
                      locations_in: np.ndarray,
                      epsg_code_from: int,
                      epsg_code_to: int) -> np.ndarray:
        """Run gdaltransform tool to transform a list of points between two EPSG codes.
    
        Args:
            gdal_tools_path: The path to the GDAL tools.
            locations_in: The locations to transform.
            epsg_code_from: The EPSG code to transform from.
            epsg_code_to: The EPSG code to transform to.
    
        Returns:
            The transformed points.
        """
        self.logger.info("Running gdaltransform to transform the locations.")
        # write the input points to a temporary file
        temp_point_file_in = filesystem.temp_filename()
        np.savetxt(temp_point_file_in, locations_in, fmt='%d')
    
        # run the command with stdin redirected from the input point file
        # and stdout redirected to the output point file
        temp_point_file_out = filesystem.temp_filename()
        try:
            transform_command = _get_command_path(gdal_tools_path, "gdaltransform")
            arguments = [transform_command, "-s_srs", f"EPSG:{epsg_code_from}", "-t_srs", f"EPSG:{epsg_code_to}"]
            with open(temp_point_file_in, "r") as point_file_in, open(temp_point_file_out, "w") as point_file_out:
                subprocess.run(arguments, stdin=point_file_in, stdout=point_file_out, stderr=subprocess.PIPE,
                               check=True)
        except subprocess.CalledProcessError as e:
            error = f"Unable to run gdaltransform: {str(e)}"
            self.fail(error)
    
        # read the transformed points from the output file
        transformed_points = np.loadtxt(temp_point_file_out)
        return transformed_points


def _get_command_path(gdal_tools_path: str, command: str):
    """Get the full command path.

    Args:
        gdal_tools_path: The path to the GDAL tools if provided.
        command: The command to be executed.

    Returns:
        str: The full path to the command, including the GDAL tools path if provided.
    """
    if gdal_tools_path:
        transform_path = Path(gdal_tools_path) / command
        transform_command = str(transform_path.as_posix())
    else:
        transform_command = command
    return transform_command
```

## Getting the Output Projection

The tool gets the WKT of the output projection using the GDAL `gdalsrsinfo`
command line utility as shown below.


```python
# Import needed for Tool
import subprocess


class TransformUgridPointsTool(Tool):
    """Tool to transform Ugrid points between projections."""
    def _wkt_from_epsg(self, gdal_tools_path: str, epsg_code: int) -> str | None:
        """Call gdalsrsinfo tool to get the WKT for an EPSG code.

        Args:
            gdal_tools_path: The path to the GDAL tools.
            epsg_code: The EPSG code.

        Returns:
            The WKT for the EPSG code.
        """
        self.logger.info("Running gdalsrsinfo to retrieve the new projection's WKT.")
        wkt = None
        try:
            gdal_srs_info_command = _get_command_path(gdal_tools_path, "gdalsrsinfo")
            arguments = [gdal_srs_info_command, "-o", "wkt", f"EPSG:{epsg_code}"]
            result = subprocess.run(arguments, capture_output=True, check=True)
            wkt = result.stdout
        except subprocess.CalledProcessError as e:
            error = f"Unable to retrieve WKT for EPSG code: {str(e)}"
            self.fail(error)
        return wkt
```

## Registering the Tool

In order for our tool to appear when running `xmstool_runner`, we need to add its information into a `Tools.xml` file. The XML file is used to find and load the available tools.

```
    <tool name="Transform UGrid points"
          category="Unstructured Grids"
          description="Transform UGrid points between projections using GDAL."
          class_name="TransformUgridPointsTool"
          module_name="xms.tool_runner.tools"
          program_name="SMS"
          uuid="86c65cd7-7478-48b1-a527-cce7b25728b9"/>
```

To complete the tool registration, the `pyproject.toml` file must include a classifier as follows:

```
[project]
...
classifiers = ['XMS DMI Definition :: XML :: xms/tool_runner/tools/Tools.xml']

[project.entry-points."xms.dmi.interfaces"]
tool_runner = "xms.tool_runner"
```

Now when the package gets installed the registered tool will be loaded into the
`tool_runner` interface.
